
/**
 * @package		Joomla.JavaScript
 * @copyright	Copyright (C) 2005 - 2015 Open Source Matters, Inc. All rights reserved.
 * @license		GNU General Public License version 2 or later; see LICENSE.txt
 * Modified by Guido De Gobbis - JoomTools
 */
!function(a){"use strict";a.JRepeatable=function(b,c){var d=this;return d&&d!==window?(d.$input=a(b),d.$input.data("JRepeatable")?d:(d.$input.data("JRepeatable",d),d.init=function(){d.options=a.extend({},a.JRepeatable.defaults,c),d.$container=a(d.options.container),a("body").append(d.$container),d.$rowsContainer=d.$container.find(d.options.repeatableElement).parent(),d.prepareModal(),d.inputs=[],d.values={},d.prepareTemplate();var b=d.$input.val();if(b)try{d.values=JSON.parse(b)}catch(e){if(e instanceof SyntaxError)try{b=b.replace(/'/g,'"').replace(/\\"/g,"'"),d.values=JSON.parse(b)}catch(e){window.console&&console.log(e)}else window.console&&console.log(e)}d.buildRows(),a(document).on("click",d.options.btModalOpen,function(a){a.preventDefault(),d.$modalWindow.modal("show")}),d.$modalWindow.on("click",d.options.btModalClose,function(a){a.preventDefault(),d.$modalWindow.modal("hide"),d.buildRows()}),d.$modalWindow.on("click",d.options.btModalSaveData,function(a){a.preventDefault(),d.$modalWindow.modal("hide"),d.refreshValue()}),d.$container.on("click",d.options.btAdd,function(b){b.preventDefault();var c=a(this).parents(d.options.repeatableElement);c.length||(c=null),d.addRow(c)}),d.$container.on("click",d.options.btRemove,function(b){b.preventDefault();var c=a(this).parents(d.options.repeatableElement);d.removeRow(c)}),d.$input.trigger("weready")},d.prepareTemplate=function(){var b=d.$container.find(d.options.repeatableElement),c=a(b.get(0));try{d.clearScripts(c)}catch(e){window.console&&console.log(e)}for(var f=c.find("*[name]"),g=0,h=f.length;h>g;g++){var i=a(f[g]).attr("name");d.values[i]||(d.inputs.push({name:i,type:a(f[g]).attr("type")||f[g].tagName.toLowerCase()}),d.values[i]=[])}d.template=c.prop("outerHTML"),b.remove(),d.$input.trigger("prepare-template",d.template)},d.prepareModal=function(){var b=a(d.options.modalElement);b.css({position:"absolute",width:"auto","max-width":"100%"}),b.on("shown",function(){d.resizeModal()}),a(window).resize(function(){d.resizeModal()}),d.$modalWindow=b.modal({show:!1,backdrop:"static"}),d.$input.trigger("prepare-modal",d.$modalWindow)},d.resizeModal=function(){if(d.$modalWindow.is(":visible")){var b=a(document).width()/2,c=d.$modalWindow.width()/2,e=d.$rowsContainer.width()/2,f=c>=b?0:-c,g=f?"50%":0,h=a(document).scrollTop()+.2*a(window).height();d.$modalWindow.css({top:h,left:g,"margin-left":f,overflow:e>c?"auto":"visible"})}},d.buildRows=function(){var a=d.$rowsContainer.children();a.length&&d.removeRow(a);for(var b=d.inputs[0],c=d.values[b.name].length||1,e=null,f=0;c>f;f++)e=d.addRow(e,f)},d.addRow=function(b,c){var e=d.$container.find(d.options.repeatableElement).length;if(e>=d.options.maximum)return null;var f=a(b).children("td").children("div")[0];if(void 0!==a(f).children('input[type="text"]').attr("id")){var g=a(f).children('input[type="text"]').attr("id");e=parseInt(g.split("-")[1])}var h=a.parseHTML(d.template);b?a(b).after(h):d.$rowsContainer.append(h);var i=a(h);if(d.fixUniqueAttributes(i,e+1),null!==c&&void 0!==c)for(var j=0,k=d.inputs.length;k>j;j++){var l=d.inputs[j].name,m=d.inputs[j].type,n=null;if(d.values[l]&&(n=d.values[l][c]),null!==n&&void 0!==n)if("radio"===m)i.find('*[name*="'+l+'"][value="'+n+'"]').attr("checked","checked");else if("checkbox"===m)if(n.length)for(var o=0,p=n.length;p>o;o++)i.find('*[name*="'+l+'"][value="'+n[o]+'"]').attr("checked","checked");else i.find('*[name*="'+l+'"][value="'+n+'"]').attr("checked","checked");else i.find('*[name*="'+l+'"]').val(n)}try{d.fixScripts(i)}catch(q){window.console&&console.log(q)}return d.$input.trigger("row-add",i),i},d.removeRow=function(b){d.$input.trigger("row-remove",b),a(b).remove()},d.fixUniqueAttributes=function(a,b){var c=a.find("*[id]");d.incresseAttrName(c,"id",b);var e=a.find("label[for]");d.incresseAttrName(e,"for",b);var f=a.find("*[name]");d.incresseAttrName(f,"name",b)},d.incresseAttrName=function(b,c,d){for(var e=0,f=b.length;f>e;e++){var g=a(b[e]),h=g.attr(c);g.attr(c,h+"-"+d)}},d.refreshValue=function(){var b=d.$container.find(d.options.repeatableElement);d.values={};for(var c=0,e=d.inputs.length;e>c;c++){var f=d.inputs[c].name,g=d.inputs[c].type;d.values[f]=[];for(var h=0,i=b.length;i>h;h++){var j=a(b[h]),k=null;if("radio"===g)k=j.find('*[name*="'+f+'"]:checked').val();else if("checkbox"===g){var l=j.find('*[name*="'+f+'"]:checked');if(l.length>1){k=[];for(var m=0,n=l.length;n>m;m++)k.push(a(l[m]).val())}else k=l.val()}else k=j.find('*[name*="'+f+'"]').val();k=null===k?"":k,d.values[f].push(k)}}d.$input.val(JSON.stringify(d.values)),d.$input.trigger("value-update",d.values)},d.clearScripts=function(b){a.fn.chosen&&b.find("select.chzn-done").chosen("destroy"),a.fn.minicolors&&(b.find(".minicolors input").each(function(){a(this).removeData("minicolors-initialized").removeData("minicolors-settings").removeProp("size").removeProp("maxlength").removeClass("minicolors-input").parents("span.minicolors").parent().append(this)}),b.find("span.minicolors").remove())},d.fixScripts=function(b){a.fn.chosen&&b.find("select").chosen(),b.find(".minicolors").each(function(){var b=a(this);b.minicolors({control:b.attr("data-control")||"hue",position:b.attr("data-position")||"right",theme:"bootstrap"})}),b.find('a[onclick*="jInsertFieldValue"]').each(function(){var b=a(this),c=b.siblings('input[type="text"]').attr("id"),d=b.prev(),e=d.attr("href");b.attr("onclick","jInsertFieldValue('', '"+c+"');return false;"),d.attr("href",e.replace(/&fieldid=(.+)&/,"&fieldid="+c+"&"))}),b.find("a.repeatable-positions").each(function(){var b=a(this),c=b.siblings('input[type="text"]').attr("id"),d=c.split("-");b.on("click",function(){setRepeatableId(d[1])})}),window.SqueezeBox&&SqueezeBox.assign(b.find("a.modal").get(),{parse:"rel"})},void d.init())):new a.JRepeatable(b,c)},a.JRepeatable.defaults={modalElement:"#modal-container",btModalOpen:"#open-modal",btModalClose:".close-modal",btModalSaveData:".save-modal-data",btAdd:"a.add",btRemove:"a.remove",maximum:10,repeatableElement:"table tbody tr"},a.fn.JRepeatable=function(b){return this.each(function(){var b=b||{},c=a(this).data();for(var d in c)c.hasOwnProperty(d)&&(b[d]=c[d]);new a.JRepeatable(this,b)})},a(window).on("load",function(){a("input.form-field-repeatable").JRepeatable()})}(jQuery);